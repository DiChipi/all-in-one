{
    "$schema": "https://schema.management.azure.com/schemas/2018-05-01/subscriptionDeploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "rgName": {
            "type": "string"
        },
        "location": {
            "type": "string"
        },
        "workspaceName": {
            "type": "string",
            "metadata": {
                "description": "Name for the Log Analytics workspace"
            }
        },
        "pricingTier": {
            "type": "string",
            "metadata": {
                "description": "Pricing tier: pergb2018 or legacy tiers (Free, Standalone, PerNode, Standard or Premium) which are not available to all customers."
            },
            "allowedValues": [
                "CapacityReservation",
                "Free",
                "LACluster",
                "PerGB2018",
                "PerNode",
                "Premium",
                "Standalone",
                "Standard"
            ],
            "defaultValue": "PerGB2018"
        },
        "capacityReservation": {
            "type": "int",
            "metadata": {
                "description": "Commitment tier"
            },
            "allowedValues": [
                100,
                200,
                300,
                400,
                500,
                1000,
                2000,
                5000
            ],
            "defaultValue": 100
        },
        "enableDataConnectors": {
            "type": "array",
            "metadata": {
                "description": "The kind of data connectors that can be deployed via ARM templates are the following: [\"AzureActivityLog\",\"SecurityInsightsSecurityEventCollectionConfiguration\",\"WindowsFirewall\",\"DnsAnalytics\"], Reference: https://docs.microsoft.com/azure/templates/microsoft.operationalinsights/2020-03-01-preview/workspaces/datasources#microsoftoperationalinsightsworkspacesdatasources-object"
            },
            "defaultValue": []
        },
        "severityLevels": {
            "type": "array",
            "metadata": {
                "description": "Severity levels desired for Analytics Rules"
            },
            "defaultValue": []
        },
        "dailyQuota": {
            "type": "int",
            "metadata": {
                "description": "Daily ingestion limit in GBs. This limit doesn't apply to the following tables: SecurityAlert, SecurityBaseline, SecurityBaselineSummary, SecurityDetection, SecurityEvent, WindowsFirewall, MaliciousIPCommunication, LinuxAuditLog, SysmonEvent, ProtectionStatus, WindowsEvent"
            }
        },
        "dataRetention": {
            "type": "int",
            "minValue": 7,
            "maxValue": 730,
            "metadata": {
                "description": "Number of days of retention. Workspaces in the legacy Free pricing tier can only have 7 days."
            },
            "defaultValue": 90
        },
        "immediatePurgeDataOn30Days": {
            "type": "bool",
            "metadata": {
                "description": "If set to true when changing retention to 30 days, older data will be immediately deleted. Use this with extreme caution. This only applies when retention is being set to 30 days."
            },
            "defaultValue": true
        },
        "enableSolutions1P": {
            "type": "array",
            "metadata": {
                "description": "The list of Content Hub 1st party solutions to deploy."
            },
            "defaultValue": []
        },
        "enableSolutionsEssentials": {
            "type": "array",
            "metadata": {
                "description": "The list of Content Hub Essentials solutions to deploy."
            },
            "defaultValue": []
        },
        "enableSolutionsTraining": {
            "type": "array",
            "metadata": {
                "description": "The list of Content Hub Training solutions to deploy."
            },
            "defaultValue": []
        },
        "aadStreams": {
            "type": "array",
            "metadata": {
                "description": "The list of data types to enable for Azure AD connector"
            },
            "defaultValue": []
        },
        "enableUeba": {
            "type": "bool",
            "metadata": {
                "description": "Whether or not UEBA should be enabled"
            },
            "defaultValue": true
        },
        "identityProviders": {
            "type": "array",
            "metadata": {
                "description": "Array of identity providers to be synched with UEBA. Valid identity providers are 'ActiveDirectory' and 'AzureActiveDirectory'"
            },
            "defaultValue": []
        },
        "enableDiagnostics": {
            "type": "bool"
        },
        "enableMLAlerts": {
            "type": "bool",
            "metadata": {
                "description": "Enable ML Behavior Analytics rules"
            },
            "defaultValue": false
        },
        "enableScheduledAlerts": {
            "type": "bool",
            "metadata": {
                "description": "Enable Scheduled analytics rules"
            },
            "defaultValue": false
        },
        "_artifactsLocation": {
            "type": "string",
            "metadata": {
                "description": "The location of resources"
            },
            "defaultValue": "https://raw.githubusercontent.com/javiersoriano/sentinel-all-in-one/master/Sentinel-All-In-One/"
        },
    "mspOfferName": {
      "type": "string",
      "defaultValue": "Microsoft Sentinel Lighthouse"
    },
    "mspOfferDescription": {
      "type": "string",
      "defaultValue": "TEST OFFER DESCRIPTION"
    },
    "managedByTenantId": {
      "type": "string",
      "defaultValue":"36386a8c-c222-407a-9bc9-af2f1b38227f"
    },
    "authorizations": {
      "type": "array",
      "defaultValue": 
      [
        {
          "principalId": "7b13a563-0edb-4e9c-a7a9-3486a1d7140d",
          "principalIdDisplayName": "Azure Security Insights - Microsoft Sentinel Automation Contributor",
          "roleDefinitionId": "f4c81013-99ee-4d62-a7ee-b3f1f648599a"
      },
  {
          "principalId": "b5d1f104-92cf-4f8a-b728-cbb2fb91e021",
          "principalIdDisplayName": "ITCSecure-SOC - Reader Role",
          "roleDefinitionId": "acdd72a7-3385-48ef-bd42-f606fba81ae7"
      },
  {
          "principalId": "4d75ad5f-edb0-43bc-a23d-7971b61ce81a",
          "principalIdDisplayName": "ITCSecure-SOC - MSR Delete Role",
          "roleDefinitionId": "91c1777a-f3dc-4fae-b103-61d183457e46"
      },
  {
          "principalId": "b5d1f104-92cf-4f8a-b728-cbb2fb91e021",
          "principalIdDisplayName": "ITCSecure-SOC - Sentinel-Responder",
          "roleDefinitionId": "3e150937-b8fe-4cfb-8069-0eaf05ecd056"
      },
  {
          "principalId": "bfb0e5c2-239b-414f-a445-11c104ec20e0",
          "principalIdDisplayName": "ITCSecure-SPN-SOC-SOAR - Lapp Contributor",
          "roleDefinitionId": "87a39d53-fc1b-424a-814c-f7e04687dc9e"
      },
  {
          "principalId": "bfb0e5c2-239b-414f-a445-11c104ec20e0",
          "principalIdDisplayName": "ITCSecure-SPN-SOC-SOAR - Log Contributor",
          "roleDefinitionId": "92aaf0da-9dab-42b6-94a3-d43ce8d16293"
      },
  {
          "principalId": "bfb0e5c2-239b-414f-a445-11c104ec20e0",
          "principalIdDisplayName": "ITCSecure-SPN-SOC-SOAR - Monitoring Contributor",
          "roleDefinitionId": "749f88d5-cbae-40b8-bcfc-e573ddc772fa"
      },
  {
          "principalId": "bfb0e5c2-239b-414f-a445-11c104ec20e0",
          "principalIdDisplayName": "ITCSecure-SPN-SOC-SOAR - Sentinel Contributor",
          "roleDefinitionId": "ab8e14d6-4a74-4a29-9ba8-549422addade"
      }
      ]

    },
    "eligibleAuthorizations": {
      "type": "array",
      "defaultValue": 
      [
        {
          "justInTimeAccessPolicy": {
            "multiFactorAuthProvider": "Azure",
            "maximumActivationDuration": "PT4H"
          },
  
          "principalId": "4d75ad5f-edb0-43bc-a23d-7971b61ce81a",
          "principalIdDisplayName": "ITCSecure-SOC - Monitoring Contributor",
          "roleDefinitionId": "749f88d5-cbae-40b8-bcfc-e573ddc772fa"
  
        },
        {
          "justInTimeAccessPolicy": {
            "multiFactorAuthProvider": "Azure",
            "maximumActivationDuration": "PT4H"
          },
          "principalId": "4d75ad5f-edb0-43bc-a23d-7971b61ce81a",
          "principalIdDisplayName": "ITCSecure-SOC – Lapp Contributor",
          "roleDefinitionId": "87a39d53-fc1b-424a-814c-f7e04687dc9e"
  
        },
        {
          "justInTimeAccessPolicy": {
            "multiFactorAuthProvider": "Azure",
            "maximumActivationDuration": "PT4H"
          },
          "principalId": "4d75ad5f-edb0-43bc-a23d-7971b61ce81a",
          "principalIdDisplayName": "ITCSecure-SOC – Log contributor",
          "roleDefinitionId": "92aaf0da-9dab-42b6-94a3-d43ce8d16293"
  
        },
        {
          "justInTimeAccessPolicy": {
            "multiFactorAuthProvider": "Azure",
            "maximumActivationDuration": "PT4H"
          },
          "principalId": "4d75ad5f-edb0-43bc-a23d-7971b61ce81a",
          "principalIdDisplayName": "ITCSecure-SOC – Sentinel Contributor",
          "roleDefinitionId": "ab8e14d6-4a74-4a29-9ba8-549422addade"
  
        },
        {
          "justInTimeAccessPolicy": {
            "multiFactorAuthProvider": "Azure",
            "maximumActivationDuration": "PT4H"
          },
          "principalId": "4d75ad5f-edb0-43bc-a23d-7971b61ce81a",
          "principalIdDisplayName": "ITCSecure-SOC – Template Spec Contributor",
          "roleDefinitionId": "1c9b6475-caf0-4164-b5a1-2142a7116f4b"
  
        },
        {
          "justInTimeAccessPolicy": {
            "multiFactorAuthProvider": "Azure",
            "maximumActivationDuration": "PT4H"
          },
          "principalId": "4d75ad5f-edb0-43bc-a23d-7971b61ce81a",
          "principalIdDisplayName": "ITCSecure-SOC – Support Request Contributor",
          "roleDefinitionId": "cfd33db0-3dd1-45e3-aa9d-cdbdf3b6f24e"
  
        }
      ]
    }
  },
  "variables": {
    "mspRegistrationName": "[guid(parameters('mspOfferName'))]",
    "mspAssignmentName": "[guid(parameters('mspOfferName'))]"
    },
    "resources": [
            {
      "type": "Microsoft.ManagedServices/registrationDefinitions",
      "apiVersion": "2020-02-01-preview",
      "name": "[variables('mspRegistrationName')]",
      "properties": {
        "registrationDefinitionName": "[parameters('mspOfferName')]",
        "description": "[parameters('mspOfferDescription')]",
        "managedByTenantId": "[parameters('managedByTenantId')]",
        "authorizations": "[parameters('authorizations')]",
        "eligibleAuthorizations": "[parameters('eligibleAuthorizations')]"
      }
    },
    {
      "type": "Microsoft.ManagedServices/registrationAssignments",
      "apiVersion": "2022-10-01",
      "name": "[variables('mspAssignmentName')]",
      "properties": {
        "registrationDefinitionId": "[subscriptionResourceId('Microsoft.ManagedServices/registrationDefinitions', variables('mspRegistrationName'))]"
      },
      "dependsOn": [
        "[subscriptionResourceId('Microsoft.ManagedServices/registrationDefinitions', variables('mspRegistrationName'))]"
      ]
    },
        {
            "type": "Microsoft.Resources/resourceGroups",
            "apiVersion": "2020-06-01",
            "name": "[parameters('rgName')]",
            "location": "[parameters('location')]",
            "properties": {}
        },
        {
            "name": "workspaceCreation",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "dependsOn": [
                "[resourceId('Microsoft.Resources/resourceGroups',parameters('rgName'))]"
            ],
            "resourceGroup": "[parameters('rgName')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), 'SubscriptionLevel/LinkedTemplates/workspace.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": {
                        "value": "[parameters('workspaceName')]"
                    },
                    "pricingTier": {
                        "value": "[parameters('pricingTier')]"
                    },
                    "dailyQuota": {
                        "value": "[parameters('dailyQuota')]"
                    },
                    "dataRetention": {
                        "value": "[parameters('dataRetention')]"
                    },
                    "immediatePurgeDataOn30Days": {
                        "value": "[parameters('immediatePurgeDataOn30Days')]"
                    },
                    "capacityReservation": {
                        "value": "[parameters('capacityReservation')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    }
                }
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "name": "settings",
            "apiVersion": "2020-06-01",
            "dependsOn": [
                "workspaceCreation"
            ],
            "resourceGroup": "[parameters('rgName')]",
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), 'SubscriptionLevel/LinkedTemplates/settings.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "workspaceName": {
                        "value": "[parameters('workspaceName')]"
                    },
                    "enableUeba": {
                        "value": "[parameters('enableUeba')]"
                    },
                    "identityProviders": {
                        "value": "[parameters('identityProviders')]"
                    },
                    "enableDiagnostics": {
                        "value": "[parameters('enableDiagnostics')]"
                    }
                }
            }
        },
        {
            "condition": "[not(empty(parameters('enableDataConnectors')))]",
            "name": "enableDataConnectors",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "resourceGroup": "[parameters('rgName')]",
            "dependsOn": [
                "workspaceCreation",
                "enableSolutionsAndAlerts"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), 'SubscriptionLevel/LinkedTemplates/dataConnectors.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "dataConnectorsKind": {
                        "value": "[parameters('enableDataConnectors')]"
                    },
                    "aadStreams": {
                        "value": "[parameters('aadStreams')]"
                    },
                    "workspaceName": {
                        "value": "[parameters('workspaceName')]"
                    },
                    "tenantId": {
                        "value": "[subscription().tenantId]"
                    },
                    "subscriptionId": {
                        "value": "[subscription().subscriptionId]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    }
                }
            }
        },
        {
            "condition": "[or(not(empty(parameters('enableSolutions1P'))),not(empty(parameters('enableSolutionsEssentials'))),not(empty(parameters('enableSolutionsTraining'))))]",
            "name": "enableSolutionsAndAlerts",
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2020-06-01",
            "resourceGroup": "[parameters('rgName')]",
            "dependsOn": [
                "workspaceCreation",
                "[resourceId('Microsoft.Resources/resourceGroups',parameters('rgName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "templateLink": {
                    "uri": "[uri(parameters('_artifactsLocation'), 'SubscriptionLevel/LinkedTemplates/solutionsAndAlerts.json')]",
                    "contentVersion": "1.0.0.0"
                },
                "parameters": {
                    "enableSolutions1P": {
                        "value": "[replace(replace(string(parameters('enableSolutions1P')),'[',''),']','')]"
                    },
                    "enableSolutionsEssentials": {
                        "value": "[replace(replace(string(parameters('enableSolutionsEssentials')),'[',''),']','')]"
                    },
                    "enableSolutionsTraining": {
                        "value": "[replace(replace(string(parameters('enableSolutionsTraining')),'[',''),']','')]"
                    },
                    "workspaceName": {
                        "value": "[parameters('workspaceName')]"
                    },
                    "severityLevels": {
                        "value": "[replace(replace(string(parameters('severityLevels')),'[',''),']','')]"
                    },
                    "enableAlerts": {
                        "value": "[parameters('enableScheduledAlerts')]"
                    },
                    "location": {
                        "value": "[parameters('location')]"
                    }
                }
            }
        }
    ],
    "outputs": {
        "workspaceName": {
            "type": "string",
            "value": "[parameters('workspaceName')]"
        },
        "dataConnectorsList": {
            "type": "string",
            "value": "[replace(replace(string(parameters('enableDataConnectors')),'\"',''),'[','')]"
        }
    }
}
